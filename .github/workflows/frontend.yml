name: Deploy Frontend of Workout Tracker

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend.yml'

jobs:
  check-backend-changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.check_backend.outputs.backend_changed }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Check for backend changes
        id: check_backend
        run: |
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^backend/' && echo "backend_changed=true" >> $GITHUB_OUTPUT || echo "backend_changed=false" >> $GITHUB_OUTPUT

  deploy-backend:
    needs: check-backend-changes
    if: needs.check-backend-changes.outputs.backend_changed == 'true'
    uses: ./.github/workflows/backend.yml

  deploy-frontend:
    needs: [check-backend-changes, deploy-backend]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: SSH into VPS and Deploy Project
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/workout-tracker

            # Pull the latest changes from the repository
            git pull origin main

            # build and run frontend
            docker compose --env-file ./backend/.env up -d backend && docker compose --env-file ./backend/.env up --build -d frontend
